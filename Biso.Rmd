---
title: "Racial Heterogeneity Variable Construction"
author: "Bernard A. Coles IV"
date: "10/21/2018"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(igraph)
library(gridExtra)
library(corrplot)
library(rethinking)
library(brms)

#Windows
load("E:/Repository/Biso/Biso/data/wave1.rda")
load("E:/Repository/Biso/Biso/data/network.wave1.rda")
load("E:/Repository/Biso/Biso/data/weights.rda")

#Mac
#load("~/desktop/Repository/Biso/data/wave1.rda")
#load("~/desktop/Repository/Biso/data/network.wave1.rda")
#load("~/desktop/Repository/Biso/data/weights.rda")

#Renamed
wave1.data <- da21600.0001
network.data <- da21600.0003
weights <- da21600.0004
```

###Consolidating the Data
```{r message=FALSE, warning=FALSE, include=FALSE}
#Merging Relevant Variables into one Data Frame
data1 <- wave1.data %>%
  dplyr :: select(AID, H1FV2, H1FV3, H1FV4, H1FV6, S6A, S6B, S6C, S6D, S6E, S4, S1, S2, PA55, H1FV9)

data2 <-  network.data %>%
  dplyr :: select(AID, ESRDEN, BCENT10X, IDGX2, SEG1RCE5, ERNRC5, EHRC5, AXS59A, AXS59B, AXS59C, AXS59D, AXS59E, AXS59F, AXS59G, SRCE51, SRCE52, SRCE53, SRCE54, SRCE55)

data3 <- weights %>%
  dplyr :: select(AID, GSWGT1)

mydata <- merge(data1, data2, by = "AID") 
#mydata <- merge(my.data, data3, by = "AID")
```

###Variable Cleaning and Construction 
```{r}
summary(wave1.data$S4)

#Race variable
mydata <- mydata %>%
  mutate(race = case_when(
    (S4 == "(1) (1) Yes (go to Q.5)" & S6A == "(1) (1) Marked") ~ "white latino",
    (S4 == "(1) (1) Yes (go to Q.5)" & S6B == "(1) (1) Marked") ~ "black latino",
    (S6A == "(1) (1) Marked" & S6B== "(1) (1) Marked") ~ "mixed race",
    (S6A == "(1) (1) Marked" & S6C == "(1) (1) Marked") ~ "mixed race",
    (S6A == "(1) (1) Marked" & S6D == "(1) (1) Marked") ~ "mixed race",
    (S6A == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    (S6B == "(1) (1) Marked" & S6C == "(1) (1) Marked") ~ "mixed race",
    (S6B == "(1) (1) Marked" & S6D == "(1) (1) Marked") ~ "mixed race",
    (S6B == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    (S6C == "(1) (1) Marked" & S6D == "(1) (1) Marked") ~ "mixed race",
    (S6C == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    (S6D == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    S4 == "(1) (1) Yes (go to Q.5)" ~ "latino", 
    S6A == "(1) (1) Marked" ~ "white",
    S6B == "(1) (1) Marked" ~ "black", 
    S6C == "(1) (1) Marked" ~ "asian", 
    S6D == "(1) (1) Marked" ~ "native american", 
    S6E == "(1) (1) Marked" ~ "other",
    T ~ NA_character_))

#Victimization
mydata <- mydata %>%
  mutate(victim = case_when(
    (H1FV2 == "(1) (1) Once" |  H1FV2 == "(2) (2) More than once") ~ 1,
    (H1FV3 == "(1) (1) Once" |  H1FV3 == "(2) (2) More than once") ~ 1,
    (H1FV4 == "(1) (1) Once" |  H1FV4 == "(2) (2) More than once") ~ 1,
    (H1FV6 == "(1) (1) Once" |  H1FV6 == "(2) (2) More than once") ~ 1,
    H1FV2 == "(0) (0) Never" ~ 0,
    H1FV3 == "(0) (0) Never" ~ 0,
    H1FV4 == "(0) (0) Never" ~ 0,
    H1FV6 == "(0) (0) Never" ~ 0,
    T ~ NA_real_))


#Creating the Network Delinquency Variable
mydata <- mydata %>%
  mutate(network.delinquency = (AXS59A + AXS59B + AXS59C + AXS59D + AXS59E + AXS59F + AXS59G)/7) 

#Cleaning Control Variables 
mydata <- mydata %>%
  mutate(sex = case_when(
    S2 == "(1) (1) Male" ~ "male",
    S2 == "(2) (2) Female" ~ "female",
    T ~ NA_character_))

mydata$age <- mydata$S1
mydata$family.income <- mydata$PA55


mydata <- mydata %>%
  mutate(weapon.carry = case_when(
    H1FV9 == "(0) (0) None (skip to Q.11)" ~ 0, 
    (H1FV9 == "(1) (1) 1 day" | H1FV9 == "(2) (2) 2 or 3 days" | H1FV9 == "(3) (3) 4 or 5 days" | H1FV9 == "(4) (4) 6 or more days") ~ 1,
    T ~ NA_real_))

#Renaming Network Variables
mydata$racial.heterogeneity <- mydata$ERNRC5
mydata$density <- mydata$ESRDEN
mydata$centrality <- mydata$BCENT10X
mydata$popularity <- mydata$IDGX2

#Variable Selection 
mydata <- mydata %>%
  select(AID, victim, race, sex, age, family.income, weapon.carry, network.delinquency, popularity, centrality, density)

#Making Categorical Variables Recognizable to the regression model 
mydata$sex <- as.factor(mydata$sex)
```

###Descriptive Statistics 
```{r}
race.plot <- mydata %>%
  filter(race != is.na(race)) %>%
  ggplot(aes(x = race, fill = race)) +
  geom_bar() +
  coord_flip()

race.victim <- mydata %>%
  filter(race != is.na(race)) %>%
  ggplot(aes(x = race)) +
  geom_bar(aes(fill = as.character(victim)), position = "fill") + 
  coord_flip()

a <- mydata %>%
  filter(race != is.na(race)) %>%
  group_by(race) %>%
  summarise(victim = mean(victim, na.rm = T)) #Native American and Black Latinos are the most victimized racial groups

b <- mydata %>%
  group_by(weapon.carry) %>%
  summarise(victim = mean(victim, na.rm = T)) #victim rate close to mean for non carriers, much higher for carriers ~ 0.58
```

###Brm() Model Construction
```{r}
#Basic Models: Variables Added in Blocks
model1 <- brm(data = mydata, family = binomial,
              victim ~ 1 + age + sex + family.income,
              prior = c(prior(normal(0, 10), class = Intercept), 
                        prior(normal(0, 10), class = b)), 
                         iter = 4000, warmup = 2000, cores = 4, chains = 4)
model2 <- update(model1, newdata = mydata, formula = victim ~ 1 + age + sex + family.income + weapon.carry + network.delinquency)
model3 <- update(model2, newdata = mydata, formula = victim ~ 1 + age + sex + family.income + weapon.carry + network.delinquency + popularity + centrality + density)

#Interaction Terms
imodel1 <- update(model3, newdata = mydata, formula = victim ~ 1 + age + sex + family.income + weapon.carry + network.delinquency + popularity + centrality + density + network.delinquency*popularity)
imodel2 <- update(imodel1, newdata = mydata, formula = victim ~ 1 + age + sex + family.income + weapon.carry + network.delinquency + popularity + centrality + density + network.delinquency*centrality)
imodel3 <- update(imodel2, newdata = mydata, formula = victim ~ 1 + age + sex + family.income + weapon.carry + network.delinquency + popularity + centrality + density + network.delinquency*density)

```

###Comparing the Models
```{r}
#Should Return a nice looking Table with the best model at the top and the worst at the bottom
model_weights(model2, model3, 
              weights = "waic") %>%
  as_tibble() %>% 
  rename(weight = value) %>% 
  mutate(model  = c("model2", "model3"),
         weight = weight %>% round(digits = 3)) %>% 
  select(model, weight) %>% 
  arrange(desc(weight)) %>% 
  knitr::kable()

model_weights(model2, model3, imodel1, imodel2, imodel3, 
              weights = "waic") %>%
  as_tibble() %>% 
  rename(weight = value) %>% 
  mutate(model  = c("model2", "model3", "imodel1", "imodel2", "imodel3"),
         weight = weight %>% round(digits = 3)) %>% 
  select(model, weight) %>% 
  arrange(desc(weight)) %>% 
  knitr::kable()
```

###Visualizing the Best Models

```{r}
#Complete Data Only
mydata.c <- mydata[complete.cases(mydata), ]

#New data frame with variables held constant - Interaction terms held at quantiles
newdata <- with(mydata.c, data.frame(age = mean(age), 
                                   sex = factor(sex), 
                                   family.income = mean(family.income), 
                                   weapon.carry = mean(weapon.carry), 
                                   network.delinquency = network.delinquency),
                                   popularity = mean(popularity), 
                                   centrality = quantile(mydata$centrality, c(.1, .5, .9)),
                                   density = mean(denisty))) #should be sliced? 

#Predicted Likelihood of Victimization added to the newdata 
newdata$victim <- predict(imodel2, newdata = newdata, type = "response")

#Visualize
ggplot(newdata, aes(x = network.delinquency, y = victim)) +
  geom_line(color = centrality)
```


```{r}
#Create Data
mean.area <- mean(data$log.area)                                            
quant.sdgs <- quantile(data$sd.growing.season, c(.1,.5,.9))                     
mgs <- seq(0, 12, length.out = 20)

predictions <- as.tibble(expand.grid(mean.area, quant.sdgs, mgs))   
colnames(predictions) <- c("mean.area", "quant.sdgs",  "mgs")      
predictions$joinby <- seq(1:nrow(predictions))                       

matrix.dim <- nrow(predictions)                                        
N <- 1e3                                                

#Sample all possible combinations
samples <- MASS::mvrnorm(mu = imodel2@coef, Sigma = model.c@vcov, n = matrix.dim*N ) %>%                        
  as.tibble %>% mutate(joinby = rep(1:matrix.dim , N))                       

samples <- full_join(samples, predictions, by = "joinby") %>%             
  mutate(gdp.hat = a + b1*mean.area + b2*mgs + b3*quant.sdgs + b4*mgs*quant.sdgs) %>%         
  group_by(quant.sdgs, mgs) %>%                              
  mutate(mu = mean(gdp.hat),                                  
        lb.mu = HPDI(gdp.hat, prob = .97)[1],                 
        ub.mu = HPDI(gdp.hat, prob = .97)[2]) %>%             
  slice(1)

#Visualize
samples$SD.Quantiles <- as.factor(samples$quant.sdgs)
samples$SD.Quantiles <- ifelse(samples$quant.sdgs == 0.527, "10th Percentile",
                             ifelse(samples$quant.sdgs == 1.690, "50th Percentile", "90th Percentile"))

ggplot(samples, aes(x = mgs , group = SD.Quantiles)) +
  geom_smooth(aes(y = mu , color = SD.Quantiles) , method = "lm" ) +
  geom_ribbon(aes(ymin = lb.mu , ymax = ub.mu) , alpha = .2)  +
  labs(title = "Language Diversity Predictions by Growing Season", x = "Average Growing Season", y = "Language Diversity")```

