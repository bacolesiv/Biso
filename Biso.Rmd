---
title: "Racial Heterogeneity Variable Construction"
author: "Bernard A. Coles IV"
date: "10/21/2018"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(igraph)
library(gridExtra)
library(corrplot)
library(rethinking)
library(brms)
library(kableExtra)

#Windows
#load("E:/Repository/Biso/Biso/data/wave1.rda")
#load("E:/Repository/Biso/Biso/data/network.wave1.rda")
#load("E:/Repository/Biso/Biso/data/weights.rda")

#Mac
load("~/desktop/Repository/Biso/data/wave1.rda")
load("~/desktop/Repository/Biso/data/network.wave1.rda")
load("~/desktop/Repository/Biso/data/weights.rda")

#Renamed
wave1.data <- da21600.0001
network.data <- da21600.0003
weights <- da21600.0004
```

###Consolidating the Data
```{r message=FALSE, warning=FALSE, include=FALSE}
#Merging Relevant Variables into one Data Frame
data1 <- wave1.data %>%
  dplyr :: select(AID, H1FV2, H1FV3, H1FV4, H1FV6, S6A, S6B, S6C, S6D, S6E, S4, S1, S2, PA55, H1FV9)

data2 <-  network.data %>%
  dplyr :: select(AID, ESRDEN, BCENT10X, IDGX2, SEG1RCE5, ERNRC5, EHRC5, AXS59A, AXS59B, AXS59C, AXS59D, AXS59E, AXS59F, AXS59G, SRCE51, SRCE52, SRCE53, SRCE54, SRCE55)

data3 <- weights %>%
  dplyr :: select(AID, GSWGT1)

mydata <- merge(data1, data2, by = "AID") 
#mydata <- merge(my.data, data3, by = "AID")
```

###Variable Cleaning and Construction 
```{r}
#Race variable
mydata <- mydata %>%
  mutate(race = case_when(
    (S4 == "(1) (1) Yes (go to Q.5)" & S6A == "(1) (1) Marked") ~ "white latino",
    (S4 == "(1) (1) Yes (go to Q.5)" & S6B == "(1) (1) Marked") ~ "black latino",
    (S6A == "(1) (1) Marked" & S6B== "(1) (1) Marked") ~ "mixed race",
    (S6A == "(1) (1) Marked" & S6C == "(1) (1) Marked") ~ "mixed race",
    (S6A == "(1) (1) Marked" & S6D == "(1) (1) Marked") ~ "mixed race",
    (S6A == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    (S6B == "(1) (1) Marked" & S6C == "(1) (1) Marked") ~ "mixed race",
    (S6B == "(1) (1) Marked" & S6D == "(1) (1) Marked") ~ "mixed race",
    (S6B == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    (S6C == "(1) (1) Marked" & S6D == "(1) (1) Marked") ~ "mixed race",
    (S6C == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    (S6D == "(1) (1) Marked" & S6E == "(1) (1) Marked") ~ "mixed race",
    S4 == "(1) (1) Yes (go to Q.5)" ~ "latino", 
    S6A == "(1) (1) Marked" ~ "white",
    S6B == "(1) (1) Marked" ~ "black", 
    S6C == "(1) (1) Marked" ~ "asian", 
    S6D == "(1) (1) Marked" ~ "native american", 
    S6E == "(1) (1) Marked" ~ "other",
    T ~ NA_character_))

#Victimization
mydata <- mydata %>%
  mutate(victim = case_when(
    (H1FV2 == "(1) (1) Once" |  H1FV2 == "(2) (2) More than once") ~ 1,
    (H1FV3 == "(1) (1) Once" |  H1FV3 == "(2) (2) More than once") ~ 1,
    (H1FV4 == "(1) (1) Once" |  H1FV4 == "(2) (2) More than once") ~ 1,
    (H1FV6 == "(1) (1) Once" |  H1FV6 == "(2) (2) More than once") ~ 1,
    H1FV2 == "(0) (0) Never" ~ 0,
    H1FV3 == "(0) (0) Never" ~ 0,
    H1FV4 == "(0) (0) Never" ~ 0,
    H1FV6 == "(0) (0) Never" ~ 0,
    T ~ NA_real_))


#Creating the Network Delinquency Variable
mydata <- mydata %>%
  mutate(network.delinquency = (AXS59A + AXS59B + AXS59C + AXS59D + AXS59E + AXS59F + AXS59G)/7) 

#Cleaning Control Variables 
mydata <- mydata %>%
  mutate(female = case_when(
    S2 == "(1) (1) Male" ~ 0,
    S2 == "(2) (2) Female" ~ 1,
    T ~ NA_real_))

mydata$age <- mydata$S1
mydata$family.income <- mydata$PA55


mydata <- mydata %>%
  mutate(weapon.carry = case_when(
    H1FV9 == "(0) (0) None (skip to Q.11)" ~ 0, 
    (H1FV9 == "(1) (1) 1 day" | H1FV9 == "(2) (2) 2 or 3 days" | H1FV9 == "(3) (3) 4 or 5 days" | H1FV9 == "(4) (4) 6 or more days") ~ 1,
    T ~ NA_real_))

#Renaming Network Variables
mydata$racial.heterogeneity <- mydata$ERNRC5
mydata$density <- mydata$ESRDEN
mydata$centrality <- mydata$BCENT10X
mydata$popularity <- mydata$IDGX2

#Variable Selection 
mydata <- mydata %>%
  select(AID, victim, race, female, age, family.income, weapon.carry, network.delinquency, popularity, centrality, density)
```

###Descriptive Statistics & Visualizations
```{r}
race.plot <- mydata %>%
  filter(race != is.na(race)) %>%
  ggplot(aes(x = race, fill = race)) +
  geom_bar() +
  coord_flip()

race.victim <- mydata %>%
  filter(race != is.na(race)) %>%
  ggplot(aes(x = race)) +
  geom_bar(aes(fill = as.character(victim)), position = "fill") + 
  coord_flip()

a <- mydata %>%
  filter(race != is.na(race)) %>%
  group_by(race) %>%
  summarise(victim = mean(victim, na.rm = T)) #Native American and Black Latinos are the most victimized racial groups

b <- mydata %>%
  group_by(weapon.carry) %>%
  summarise(victim = mean(victim, na.rm = T)) #victim rate close to mean for non carriers, much higher for carriers ~ 0.58

grid.arrange(race.plot, race.victim, nrow = 2, top = "Victimization & Race")
```

###Model Construction
```{r message=FALSE, warning=FALSE, include=FALSE}
#Only complete rows Kept
mydata.c <- mydata[complete.cases(mydata), ]

#Making models: Map logitstic regressions
model <- map(alist(
  victim ~ dbinom(1, p),
  logit(p) <- a + b1*age + b2*female + b3*family.income + b4*weapon.carry + b5*network.delinquency + b6*popularity + b7*centrality + b8*density,
  a ~ dnorm(0,10),
  b1 ~ dnorm(0,10),
  b2 ~ dnorm(0,10),
  b3 ~ dnorm(0,10),
  b4 ~ dnorm(0,10),
  b5 ~ dnorm(0,10),
  b6 ~ dnorm(0,10), 
  b7 ~ dnorm(0,10), 
  b8 ~ dnorm(0,10)), data=mydata.c, start=list(b1=0, b2=0, b3=0, b4=0, b5=0, b6=0, b7=0, b8=0))

imodel1 <- map(alist(
  victim ~ dbinom(1, p),
  logit(p) <- a + b1*age + b2*female + b3*family.income + b4*weapon.carry + b5*network.delinquency + b6*popularity + b7*centrality + b8*density + b9*network.delinquency*centrality,
  a ~ dnorm(0,10),
  b1 ~ dnorm(0,10),
  b2 ~ dnorm(0,10),
  b3 ~ dnorm(0,10),
  b4 ~ dnorm(0,10),
  b5 ~ dnorm(0,10),
  b6 ~ dnorm(0,10), 
  b7 ~ dnorm(0,10), 
  b8 ~ dnorm(0,10), 
  b9 ~ dnorm(0,10)), data=mydata.c, start=list(b1=0, b2=0, b3=0, b4=0, b5=0, b6=0, b7=0, b8=0, b9=0))

imodel2 <- map(alist(
  victim ~ dbinom(1, p),
  logit(p) <- a + b1*age + b2*female + b3*family.income + b4*weapon.carry + b5*network.delinquency + b6*popularity + b7*centrality + b8*density + b9*network.delinquency*popularity,
  a ~ dnorm(0,10),
  b1 ~ dnorm(0,10),
  b2 ~ dnorm(0,10),
  b3 ~ dnorm(0,10),
  b4 ~ dnorm(0,10),
  b5 ~ dnorm(0,10),
  b6 ~ dnorm(0,10), 
  b7 ~ dnorm(0,10), 
  b8 ~ dnorm(0,10), 
  b9 ~ dnorm(0,10)), data=mydata.c, start=list(b1=0, b2=0, b3=0, b4=0, b5=0, b6=0, b7=0, b8=0, b9=0))

imodel3 <- map(alist(
  victim ~ dbinom(1, p),
  logit(p) <- a + b1*age + b2*female + b3*family.income + b4*weapon.carry + b5*network.delinquency + b6*popularity + b7*centrality + b8*density + b9*network.delinquency*density,
  a ~ dnorm(0,10),
  b1 ~ dnorm(0,10),
  b2 ~ dnorm(0,10),
  b3 ~ dnorm(0,10),
  b4 ~ dnorm(0,10),
  b5 ~ dnorm(0,10),
  b6 ~ dnorm(0,10), 
  b7 ~ dnorm(0,10), 
  b8 ~ dnorm(0,10), 
  b9 ~ dnorm(0,10)), data=mydata.c, start=list(b1=0, b2=0, b3=0, b4=0, b5=0, b6=0, b7=0, b8=0, b9=0))

m1 <- as.data.frame((imodel1@coef),1)
m2 <- as.data.frame((imodel2@coef),1)
m3 <- as.data.frame((imodel3@coef),1)
```

###Comparing the Models with Information Criteria
```{r}
compare(model, imodel1, imodel3)
compare(model, imodel2, imodel3)

#Code to return a clean table with the best model on top -> must translate for map models 
model_weights(b6.11, b6.12, b6.13, b6.14, 
              weights = "waic") %>%
  as_tibble() %>% 
  rename(weight = value) %>% 
  mutate(model  = c("b6.11", "b6.12", "b6.13", "b6.14"),
         weight = weight %>% round(digits = 2)) %>% 
  select(model, weight) %>% 
  arrange(desc(weight)) %>% 
  knitr::kable()
```

###Visualizing Centrality Model
```{r}
#New data frame with variables held constant - Interaction terms held at quantiles
age <- mean(mydata.c$age)
female <- mean(mydata.c$female)
family.income <- mean(mydata.c$family.income)
weapon.carry <- mean(mydata.c$weapon.carry)
network.delinquency <- seq(0, 5, by = .1)
popularity <- mean(mydata.c$popularity)
centrality <- quantile(mydata.c$centrality, c(.1, .5, .9))
density <- mean(mydata.c$density)


predictions <- as.tibble(expand.grid(age, female, family.income, weapon.carry, network.delinquency, popularity, centrality, density))   
colnames(predictions) <- c("age", "female", "family.income", "weapon.carry", "network.delinquency", "popularity", "centrality", "density")      

#Predicted Likelihood of Victimization added to the newdata 
samples <- predictions %>%             
  mutate(victim = logistic(m1[10,] + m1[1,]*age + m1[2,]*female + m1[3,]*family.income + m1[4,]*weapon.carry + m1[5,]*network.delinquency + m1[6,]*popularity + m1[7,]*centrality + m1[8,]*density + m1[9,]*network.delinquency*centrality)) %>%         
  group_by(network.delinquency, centrality) %>%                              
  slice(1)

#Visualize: Centrality Interactions
samples$centrality <- as.character(samples$centrality)
samples <- samples %>%
  mutate(Centrality = case_when(
    centrality == "0" ~ "10th Percentile",
    centrality == "0.7867627910904" ~ "50th Percentile",
    centrality == "1.70167438806094"  ~ "90th Percentile",
    T ~ NA_character_))

ggplot(samples, aes(x = network.delinquency , group = Centrality)) +
  geom_line(aes(y = victim, color = Centrality), size = 1.5) +
  labs(title = "Adolescent Victimization", x = "Average Delinquency in Friendship Network", y = "Probability of Victimization")
```

###Visualizing Popularity Model 
```{r}
#New data frame with variables held constant - Interaction terms held at quantiles
age <- mean(mydata.c$age)
female <- mean(mydata.c$female)
family.income <- mean(mydata.c$family.income)
weapon.carry <- mean(mydata.c$weapon.carry, na.rm = T)
network.delinquency <- seq(0, 5, by = .1)
centrality <- mean(mydata.c$centrality, na.rm = T)
popularity <- quantile(mydata.c$popularity, c(.1, .5, .9))
density <- mean(mydata.c$density, na.rm = T)

predictions <- as.tibble(expand.grid(age, female, family.income, weapon.carry, network.delinquency, popularity, centrality, density))   
colnames(predictions) <- c("age", "female", "family.income", "weapon.carry", "network.delinquency", "popularity", "centrality", "density")      

#Predicted Likelihood of Victimization added to the newdata 
samples <- predictions %>%             
  mutate(victim = logistic(m2[10,] + m2[1,]*age + m2[2,]*female + m2[3,]*family.income + m2[4,]*weapon.carry + m2[5,]*network.delinquency + m2[6,]*popularity + m2[7,]*centrality + m2[8,]*density + m2[9,]*network.delinquency*popularity)) %>%         
  group_by(network.delinquency, popularity) %>%                              
  slice(1)

#Visualize: Centrality Interactions
samples <- samples %>%
  mutate(Popularity = case_when(
    popularity == 1 ~ "10th Percentile",
    popularity == 4 ~ "50th Percentile",
    popularity == 10  ~ "90th Percentile",
    T ~ NA_character_))

samples$Popularity <- as.factor(samples$Popularity)

ggplot(samples, aes(x = network.delinquency , group = Popularity)) +
  geom_line(aes(y = victim, color = Popularity) , size = 1.5) +
  labs(title = "Adolescent Victimization", x = "Average Delinquency in Friendship Network", y = "Probability of Victimization")
```

###Visualizing Density Model
```{r}
#New data frame with variables held constant - Interaction terms held at quantiles
age <- mean(mydata.c$age)
female <- mean(mydata.c$female)
family.income <- mean(mydata.c$family.income)
weapon.carry <- mean(mydata.c$weapon.carry, na.rm = T)
network.delinquency <- seq(0, 5, by = .1)
centrality <- mean(mydata.c$centrality, na.rm = T)
density <- quantile(mydata.c$density, c(.1, .5, .9))
popularity <- mean(mydata.c$popularity, na.rm = T)

predictions <- as.tibble(expand.grid(age, female, family.income, weapon.carry, network.delinquency, popularity, centrality, density))   
colnames(predictions) <- c("age", "female", "family.income", "weapon.carry", "network.delinquency", "popularity", "centrality", "density")      
#Predicted Likelihood of Victimization added to the newdata 
samples <- predictions%>%             
  mutate(victim = logistic(m3[10,] + m3[1,]*age + m3[2,]*female + m3[3,]*family.income + m3[4,]*weapon.carry + m3[5,]*network.delinquency + m3[6,]*popularity + m3[7,]*centrality + m3[8,]*density + m3[9,]*network.delinquency*density))%>%         
  group_by(network.delinquency, density) %>%                              
  slice(1)


#Visualize: Centrality Interactions
samples$density <- as.character(samples$density)

samples <- samples %>%
  mutate(Density = case_when(
    density == "0.1571428571429" ~ "10th Percentile",
    density == "0.2619047619048" ~ "50th Percentile",
    density == "0.5"  ~ "90th Percentile",
    T ~ NA_character_))

ggplot(samples, aes(x = network.delinquency , group = Density)) +
  geom_line(aes(y = victim, color = Density) , size = 1.5) +
  labs(title = "Adolescent Victimization", x = "Average Delinquency in Friendship Network", y = "Probability of Victimization")
```

































